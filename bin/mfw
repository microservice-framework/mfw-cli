#!/usr/bin/env node

'use strict';

const commander = require('commander');
const path = require('path');
const fs = require('fs');
const pkg = require('../package.json');
const Message = require('../includes/message.js');
const MFWCli = require('../includes/MFWCliClass.js');
const exec = require('child_process').exec;

commander.version(pkg.version).usage('[cmd] [module]');

commander.option('-e, --env <name>', 'Environment. Helps to separate production, stage, devel.')

commander.command('setup [dir]')
  .description('setup directory')
  .action(setupDir);

commander.command('install <module>')
  .description('Install microservice')
  .option('-r, --root <dir>', 'Optionaly root directory')
  .option('-s, --save', 'Save microservice information')
  .action(installService);

commander.command('update <module>')
  .description('Update microservice')
  .option('-r, --root <dir>', 'Optionaly root directory')
  .action(updateService);

commander.command('uninstall <module>')
  .description('Uninstall microservice')
  .option('-r, --root <dir>', 'Optionaly root directory')
  .option('-s, --save', 'Save microservice information')
  .action(uninstallService);


commander.parse(process.argv);

if (process.argv.length == 2) {
  commander.outputHelp();
}

function setupDir(dir, options) {
  if (!dir) {
    dir = process.cwd();
  }
  var resolve = path.resolve(dir);

  var envName = options.env;
  if (!envName) {
    envName = '';
  }

  MFWCli.setup(resolve, envName);
}

function installService(service, options) {
  var rootDIR = options.root;
  if (!rootDIR) {
    rootDIR = process.cwd();
  }
  var resolve = path.resolve(rootDIR);
  var envName = options.env;
  if (!envName) {
    envName = '';
  }
  MFWCli.install(resolve, service, options.save, envName);
}

function updateService(service, options) {
  var rootDIR = options.root;
  if (!rootDIR) {
    rootDIR = process.cwd();
  }
  var resolve = path.resolve(rootDIR);
  var envName = options.env;
  if (!envName) {
    envName = '';
  }
  MFWCli.update(resolve, service, envName);
}

function uninstallService(service, options) {
  var rootDIR = options.root;
  if (!rootDIR) {
    rootDIR = process.cwd();
  }
  var resolve = path.resolve(rootDIR);
  var envName = options.env;
  if (!envName) {
    envName = '';
  }
  MFWCli.uninstall(resolve, service, options.save, envName);
}

