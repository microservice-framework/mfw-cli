#!/usr/bin/env node

'use strict';

const commander = require('commander');
const path = require('path');
const fs = require('fs');
const pkg = require('../package.json');
const Message = require('../includes/message.js');
const MFWCli = require('../includes/MFWCliClass.js');
const exec = require('child_process').exec;

commander.version(pkg.version).usage('[cmd] [module]');

//commander.option('-e, --env <name>', 'Environment. Helps to separate production, stage, devel.')

commander.command('setup [dir]')
  .description('setup directory')
  .option('-e, --env <name>', 'Environment. Helps to separate production, stage, devel.')
  .action(setupDir);

commander.command('install <module>')
  .description('Install microservice')
  .option('-r, --root <dir>', 'Optionaly root directory')
  .option('-s, --save', 'Save microservice information')
  .option('-e, --env <name>', 'Environment. Helps to separate production, stage, devel.')
  .action(installService);

commander.command('update [module]')
  .description('Update microservice')
  .option('-r, --root <dir>', 'Optionaly root directory')
  .option('-e, --env <name>', 'Environment. Helps to separate production, stage, devel.')
  .action(updateService);

commander.command('uninstall <module>')
  .description('Uninstall microservice')
  .option('-r, --root <dir>', 'Optionaly root directory')
  .option('-s, --save', 'Save microservice information')
  .option('-e, --env <name>', 'Environment. Helps to separate production, stage, devel.')
  .action(uninstallService);

commander.command('env [env]')
  .description('setup directory')
  .option('-l, --list', 'List enabled Environments.')
  .option('-e, --extended', 'Print extended info')
  .option('-r, --root <dir>', 'Optionaly root directory')
  .action(envList);

commander.parse(process.argv);

if (process.argv.length == 2) {
  commander.outputHelp();
}

/**
 * Process setup option.
 */
function setupDir(dir, options) {
  if (!dir) {
    dir = process.cwd();
  }
  var resolve = path.resolve(dir);
  var envName = options.env;
  if (!envName) {
    envName = '';
  }

  MFWCli.setup(resolve, envName);
}

/**
 * Process install option.
 */
function installService(service, options) {
  var rootDIR = options.root;
  if (!rootDIR) {
    rootDIR = process.cwd();
  }
  var resolve = path.resolve(rootDIR);
  var envName = options.env;
  if (!envName) {
    envName = '';
  }
  MFWCli.install(resolve, service, options.save, envName);
}

/**
 * Process update option.
 */
function updateService(service, options) {
  var rootDIR = options.root;
  if (!rootDIR) {
    rootDIR = process.cwd();
  }
  var resolve = path.resolve(rootDIR);
  var envName = options.env;
  if (!envName) {
    envName = '';
  }
  if(service) {
    return MFWCli.update(resolve, service, envName);
  }
  MFWCli.updateAll(resolve, envName);
}

function uninstallService(service, options) {
  var rootDIR = options.root;
  if (!rootDIR) {
    rootDIR = process.cwd();
  }
  var resolve = path.resolve(rootDIR);
  var envName = options.env;
  if (!envName) {
    envName = '';
  }
  MFWCli.uninstall(resolve, service, options.save, envName);
}

/**
 * Process env option.
 */
function envList(envName, options) {
  var rootDIR = options.root;
  if (!rootDIR) {
    rootDIR = process.cwd();
  }
  var resolve = path.resolve(rootDIR);
  if(envName) {
    if(envName == 'default') {
      envName = '';
    }
    return MFWCli.envSet(resolve, envName);
  }
  if(options.list) {
    var envs = findEnvironments(resolve, options.extended);
    console.log(envs);
  }
}

/**
 * Find env packages.
 */
function findEnvironments(startPath, isExtended){

  var results = {};
  var filter = 'package.json';

  if (!fs.existsSync(startPath)){
    return;
  }

  var files = fs.readdirSync(startPath);
  for( var i=0; i < files.length; i++){
    var filename = files[i];
    var index = filename.indexOf(filter);
    var packageJSON = '';
    if(index >= 0 ) {
      if(isExtended) {
        try {
          packageJSON = JSON.parse(fs.readFileSync(path.join(startPath,filename)));
        } catch (e) {
          return console.log(e);
        }
      } else {
        packageJSON = filename;
      }
    }
    if(index == 0) {
      results['default'] = packageJSON;
    }
    if(index > 0){
      var env = filename.substring(0,index - 1);
      results[env] = packageJSON;
    }
  }
  return results;
}
